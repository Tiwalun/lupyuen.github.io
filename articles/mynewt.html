<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Porting Mynewt to PineCone BL602</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Porting Mynewt to PineCone BL602" 
    data-rh="true">
<meta property="og:description" 
    content="How we port Apache Mynewt embedded operating system to the PineCone BL602 RISC-V Board" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/mynewt-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Porting Mynewt to PineCone BL602</h1>
    <nav id="TOC"><ul>
<li><a href="#adapt-from-existing-risc-v-port">1 Adapt from Existing RISC-V Port</a><ul></ul></li>
<li><a href="#set-gcc-compiler-for-risc-v">2 Set GCC Compiler for RISC-V</a><ul></ul></li>
<li><a href="#add-microcontroller-definition">3 Add Microcontroller Definition</a><ul></ul></li>
<li><a href="#add-board-support-package">4 Add Board Support Package</a><ul></ul></li>
<li><a href="#define-firmware-memory-map">5 Define Firmware Memory Map</a><ul></ul></li>
<li><a href="#define-linker-script">6 Define Linker Script</a><ul></ul></li>
<li><a href="#set-firmware-target">7 Set Firmware Target</a><ul></ul></li>
<li><a href="#build-the-firmware">8 Build the Firmware</a><ul></ul></li>
<li><a href="#replace-hal-functions-by-stubs">9 Replace HAL Functions by Stubs</a><ul></ul></li>
<li><a href="#fill-in-start-code">10 Fill in Start Code</a><ul></ul></li>
<li><a href="#decouple-sifive-fe310-from-rv32imac">11 Decouple SiFive FE310 from RV32IMAC</a><ul></ul></li>
<li><a href="#inspect-the-firmware">12 Inspect the Firmware</a><ul></ul></li>
<li><a href="#debug-firmware-with-vscode">13 Debug Firmware with VSCode</a><ul></ul></li>
<li><a href="#load-firmware-to-ram-not-flash-memory">14 Load Firmware to RAM, not Flash Memory</a><ul></ul></li>
<li><a href="#todo">15 TODO</a><ul></ul></li>
<li><a href="#whats-next">16 What's Next</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/mynewt-title.jpg" alt="PineCone BL602 RISC-V Evaluation Board with Sipeed JTAG Debugger" /></p>
<p>Our story so far... </p>
<ol>
<li>
<p>We took a quick peek at <a href="https://lupyuen.github.io/articles/pinecone"><strong>PineCone BL602 RISC-V Evaluation Board</strong></a>...</p>
</li>
<li>
<p>Then we <a href="https://lupyuen.github.io/articles/openocd"><strong>connected PineCone to OpenOCD</strong></a> with a JTAG Debugger...</p>
</li>
<li>
<p>And we <a href="https://lupyuen.github.io/articles/debug"><strong>debugged Rust on PineCone with VSCode and GDB</strong></a></p>
</li>
</ol>
<p>Today we'll learn about our ongoing port of Apache Mynewt embedded operating system to PineCone.</p>
<h1 id="adapt-from-existing-risc-v-port" class="section-header"><a href="#adapt-from-existing-risc-v-port">1 Adapt from Existing RISC-V Port</a></h1>
<p>TODO</p>
<h1 id="set-gcc-compiler-for-risc-v" class="section-header"><a href="#set-gcc-compiler-for-risc-v">2 Set GCC Compiler for RISC-V</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/mynewt-gcc.png" alt="Mynewt GCC" /></p>
<p><img src="https://lupyuen.github.io/images/mynewt-gcc2.png" alt="Mynewt GCC" /></p>
<h1 id="add-microcontroller-definition" class="section-header"><a href="#add-microcontroller-definition">3 Add Microcontroller Definition</a></h1>
<p>TODO</p>
<h1 id="add-board-support-package" class="section-header"><a href="#add-board-support-package">4 Add Board Support Package</a></h1>
<p>TODO</p>
<h1 id="define-firmware-memory-map" class="section-header"><a href="#define-firmware-memory-map">5 Define Firmware Memory Map</a></h1>
<p>TODO</p>
<h1 id="define-linker-script" class="section-header"><a href="#define-linker-script">6 Define Linker Script</a></h1>
<p>TODO</p>
<h1 id="set-firmware-target" class="section-header"><a href="#set-firmware-target">7 Set Firmware Target</a></h1>
<p>TODO</p>
<h1 id="build-the-firmware" class="section-header"><a href="#build-the-firmware">8 Build the Firmware</a></h1>
<p>TODO</p>
<h1 id="replace-hal-functions-by-stubs" class="section-header"><a href="#replace-hal-functions-by-stubs">9 Replace HAL Functions by Stubs</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/mynewt-hal.png" alt="Mynewt HAL" /></p>
<h1 id="fill-in-start-code" class="section-header"><a href="#fill-in-start-code">10 Fill in Start Code</a></h1>
<p>TODO</p>
<h1 id="decouple-sifive-fe310-from-rv32imac" class="section-header"><a href="#decouple-sifive-fe310-from-rv32imac">11 Decouple SiFive FE310 from RV32IMAC</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/mynewt-fe310.png" alt="SiFive FE310 Reference in RV32IMAC" /></p>
<h1 id="inspect-the-firmware" class="section-header"><a href="#inspect-the-firmware">12 Inspect the Firmware</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/mynewt-disassembly.png" alt="Mynewt Disassembly" /></p>
<h1 id="debug-firmware-with-vscode" class="section-header"><a href="#debug-firmware-with-vscode">13 Debug Firmware with VSCode</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/mynewt-debug.png" alt="Mynewt Debugging" /></p>
<h1 id="load-firmware-to-ram-not-flash-memory" class="section-header"><a href="#load-firmware-to-ram-not-flash-memory">14 Load Firmware to RAM, not Flash Memory</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/mynewt-flash.png" alt="Loading Mynewt Firmware to Flash Memory" /></p>
<p><img src="https://lupyuen.github.io/images/mynewt-ram.png" alt="Loading Mynewt Firmware to RAM" /></p>
<h1 id="todo" class="section-header"><a href="#todo">15 TODO</a></h1>
<pre><code class="language-bash">#  Download the source files
git clone --recursive https://github.com/lupyuen/pinecone-rust-mynewt
cd pinecone-rust-mynewt
newt install
#  TODO: Download xpack-riscv-none-embed-gcc here

#  Build the firmware
export PATH=&quot;$PWD/xpack-riscv-none-embed-gcc/bin:$PATH&quot;
newt build pinecone_app
</code></pre>
<ol>
<li>
<p>BL602 MCU Definition: <a href="hw/mcu/bl/bl602/pkg.yml"><code>hw/mcu/bl/bl602/pkg.yml</code></a></p>
</li>
<li>
<p>PineCone Board Support Package: <a href="hw/bsp/pinecone/bsp.yml"><code>hw/bsp/pinecone/bsp.yml</code></a></p>
</li>
<li>
<p>Compile with <code>riscv-none-embed-gcc</code> instead of <code>riscv64-unknown-elf-gcc</code></p>
<p>See <a href="compiler/riscv-none-embed/compiler.yml"><code>compiler/riscv-none-embed/compiler.yml</code></a></p>
</li>
<li>
<p>Mynewt Firmware should look similar to this disassembled Hello World firmware...</p>
<p>https://github.com/lupyuen/bl_iot_sdk/releases/download/v0.0.4/sdk_app_helloworld.S</p>
</li>
<li>
<p>Mynewt Firmware should use this Start Code...</p>
<p>https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602/evb/src/boot/gcc/start.S</p>
</li>
<li>
<p>Memory map should be...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Name</span>             <span class="ident">Origin</span>             <span class="ident">Length</span>             <span class="ident">Attributes</span>
<span class="ident">rom</span>              <span class="number">0x0000000021015000</span> <span class="number">0x000000000000b000</span> <span class="ident">axrl</span> <span class="op">!</span><span class="ident">w</span>
<span class="ident">flash</span>            <span class="number">0x0000000023000000</span> <span class="number">0x0000000000400000</span> <span class="ident">axrl</span> <span class="op">!</span><span class="ident">w</span>
<span class="ident">ram_tcm</span>          <span class="number">0x000000004200c000</span> <span class="number">0x0000000000036000</span> <span class="ident">axw</span>
<span class="ident">ram_wifi</span>         <span class="number">0x0000000042042000</span> <span class="number">0x000000000000a000</span> <span class="ident">axw</span>
<span class="kw-2">*</span><span class="ident">default</span><span class="op">*</span>        <span class="number">0x0000000000000000</span> <span class="number">0xffffffffffffffff</span></pre></div>
<p>Based on...</p>
<p>https://github.com/lupyuen/bl_iot_sdk/releases/download/v0.0.4/sdk_app_helloworld.map</p>
<p>https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602/evb/ld/flash_rom.ld#L7-L13</p>
</li>
<li>
<p>Fix dependency of rv32imac on fe310...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Error</span>: <span class="ident">In</span> <span class="ident">file</span> <span class="ident">included</span> <span class="ident">from</span> <span class="ident">repos</span><span class="op">/</span><span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">core</span><span class="op">/</span><span class="ident">kernel</span><span class="op">/</span><span class="ident">os</span><span class="op">/</span><span class="ident">include</span><span class="op">/</span><span class="ident">os</span><span class="op">/</span><span class="ident">os_fault</span>.<span class="ident">h</span>:<span class="number">24</span>,
             <span class="ident">from</span> <span class="ident">repos</span><span class="op">/</span><span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">core</span><span class="op">/</span><span class="ident">libc</span><span class="op">/</span><span class="ident">baselibc</span><span class="op">/</span><span class="ident">include</span><span class="op">/</span><span class="ident">assert</span>.<span class="ident">h</span>:<span class="number">24</span>,
             <span class="ident">from</span> <span class="ident">repos</span><span class="op">/</span><span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">core</span><span class="op">/</span><span class="ident">hw</span><span class="op">/</span><span class="ident">hal</span><span class="op">/</span><span class="ident">src</span><span class="op">/</span><span class="ident">hal_flash</span>.<span class="ident">c</span>:<span class="number">21</span>:
<span class="ident">repos</span><span class="op">/</span><span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">core</span><span class="op">/</span><span class="ident">kernel</span><span class="op">/</span><span class="ident">os</span><span class="op">/</span><span class="ident">include</span><span class="op">/</span><span class="ident">os</span><span class="op">/</span><span class="ident">arch</span><span class="op">/</span><span class="ident">rv32imac</span><span class="op">/</span><span class="ident">os</span><span class="op">/</span><span class="ident">os_arch</span>.<span class="ident">h</span>:<span class="number">24</span>:<span class="number">10</span>: <span class="ident">fatal</span> <span class="ident">error</span>: <span class="ident">mcu</span><span class="op">/</span><span class="ident">fe310</span>.<span class="ident">h</span>: <span class="ident">No</span> <span class="ident">such</span> <span class="ident">file</span> <span class="ident">or</span> <span class="ident">directory</span>
#<span class="ident">include</span> <span class="string">&quot;mcu/fe310.h&quot;</span></pre></div>
</li>
</ol>
<h1 id="whats-next" class="section-header"><a href="#whats-next">16 What's Next</a></h1>
<p>TODO</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here...</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/mynewt.md"><code>github.com/lupyuen/lupyuen.github.io/src/mynewt.md</code></a></p>

    
</body>
</html>