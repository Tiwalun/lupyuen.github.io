<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Porting Mynewt to PineCone BL602</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Porting Mynewt to PineCone BL602" 
    data-rh="true">
<meta property="og:description" 
    content="How we port Apache Mynewt embedded operating system to the PineCone BL602 RISC-V Board" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/mynewt-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Porting Mynewt to PineCone BL602</h1>
    <nav id="TOC"><ul>
<li><a href="#adapt-from-existing-risc-v-port">1 Adapt from Existing RISC-V Port</a><ul></ul></li>
<li><a href="#set-gcc-compiler-for-risc-v">2 Set GCC Compiler for RISC-V</a><ul>
<li><a href="#mynewt-project-and-firmware">2.1 Mynewt Project and Firmware</a><ul></ul></li></ul></li>
<li><a href="#add-microcontroller-definition">3 Add Microcontroller Definition</a><ul></ul></li>
<li><a href="#add-board-support-package">4 Add Board Support Package</a><ul></ul></li>
<li><a href="#define-linker-script">5 Define Linker Script</a><ul>
<li><a href="#bootloader-image-header">5.1 Bootloader Image Header</a><ul></ul></li></ul></li>
<li><a href="#define-flash-map">6 Define Flash Map</a><ul>
<li><a href="#future-flash-map">6.1 Future Flash Map</a><ul></ul></li></ul></li>
<li><a href="#set-firmware-target">7 Set Firmware Target</a><ul></ul></li>
<li><a href="#build-the-firmware">8 Build the Firmware</a><ul></ul></li>
<li><a href="#replace-hal-functions-by-stubs">9 Replace HAL Functions by Stubs</a><ul></ul></li>
<li><a href="#fill-in-start-code">10 Fill in Start Code</a><ul></ul></li>
<li><a href="#decouple-sifive-fe310-from-rv32imac">11 Decouple SiFive FE310 from RV32IMAC</a><ul></ul></li>
<li><a href="#inspect-the-firmware">12 Inspect the Firmware</a><ul></ul></li>
<li><a href="#debug-firmware-with-vscode">13 Debug Firmware with VSCode</a><ul></ul></li>
<li><a href="#load-firmware-to-ram-not-flash-memory">14 Load Firmware to RAM, not Flash Memory</a><ul></ul></li>
<li><a href="#how-to-test">15 How To Test</a><ul></ul></li>
<li><a href="#whats-next">16 What's Next</a><ul></ul></li>
<li><a href="#appendix-install-newt">17 Appendix: Install newt</a><ul></ul></li>
<li><a href="#appendix-create-the-mynewt-firmware">18 Appendix: Create the Mynewt Firmware</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/mynewt-title.jpg" alt="PineCone BL602 RISC-V Evaluation Board with Sipeed JTAG Debugger" /></p>
<p>Our journey so far... </p>
<ol>
<li>
<p>We took a quick peek at <a href="https://lupyuen.github.io/articles/pinecone"><strong>PineCone BL602 RISC-V Evaluation Board</strong></a>...</p>
</li>
<li>
<p>Then we <a href="https://lupyuen.github.io/articles/openocd"><strong>connected PineCone to OpenOCD</strong></a> with a JTAG Debugger...</p>
</li>
<li>
<p>And we <a href="https://lupyuen.github.io/articles/debug"><strong>debugged Rust on PineCone</strong></a> with VSCode and GDB</p>
</li>
</ol>
<p>Today we'll learn about our ongoing port of Apache Mynewt embedded operating system to PineCone.</p>
<p><em>Why port Mynewt to BL602?</em></p>
<p>Since FreeRTOS is already supported on BL602 (for multitasking Bluetooth LE and WiFi in the background), let's port a modern embedded operating system like Mynewt.</p>
<p>It's a great way to learn the internals of BL602.  And this article will be a valuable resource for porting to BL602 other embedded operating systems, like Zephyr and RIOT.</p>
<h1 id="adapt-from-existing-risc-v-port" class="section-header"><a href="#adapt-from-existing-risc-v-port">1 Adapt from Existing RISC-V Port</a></h1>
<p><em>What's the quickest way to port Mynewt to PineCone BL602?</em></p>
<p>There's one (and only one) RISC-V Board supported today on Mynewt: <strong>SiFive's HiFive1 Board</strong>, based on the <strong>SiFive FE310 Microcontroller</strong>.</p>
<p>We shall copy and adapt the necessary files from the HiFive1 FE310 port to our PineCone BL602 port.</p>
<p><em>How different is BL602 from SiFive FE310?</em></p>
<p>The Memory Maps for BL602 and SiFive FE310 look totally different...</p>
<p><img src="https://lupyuen.github.io/images/pinecone-compare.jpg" alt="BL602 Memory Map vs SiFive FE310: Totally different" /></p>
<p><em>BL602 Memory Map (left) vs SiFive FE310 (right): Totally different</em></p>
<p>But <strong>BL602's RISC-V Core is highly similar to SiFive FE310</strong>. Compare these two files...</p>
<ol>
<li>
<p><a href="https://github.com/pine64/bl_iot_sdk/blob/master/components/bl602/freertos_riscv/config/platform.h"><code>platform.h</code> from <strong>BL602 IoT SDK</strong></a></p>
</li>
<li>
<p><a href="https://github.com/apache/mynewt-core/blob/master/hw/mcu/sifive/src/ext/freedom-e-sdk_3235929/bsp/env/freedom-e300-hifive1/platform.h"><code>platform.h</code> from <strong>Mynewt's FE310 Port</strong></a></p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/mynewt-platform.png" alt="platform.h: BL602 (left) vs SiFive FE310 (right)" /></p>
<p><em>platform.h: BL602 (left) vs SiFive FE310 (right)</em></p>
<p>Since BL602's RISC-V Core is so similar to FE310, it makes porting simpler.</p>
<p><img src="https://lupyuen.github.io/images/mynewt-e21.png" alt="BL602 is based on SiFive E21 RISC-V Core" /></p>
<p><em>BL602 is based on which SiFive RISC-V Core?</em></p>
<p>From the screenshot above, the name &quot;E21&quot; appears (over a hundred times) in the BL602 IoT SDK.</p>
<p>Thus we assume that BL602 is based on the <strong>SiFive E21 RISC-V Core</strong> (and not E24)...</p>
<ul>
<li><a href="https://sifive.cdn.prismic.io/sifive/39d336f7-7dba-43f2-a453-8d55227976cc_sifive_E21_rtl_full_20G1.03.00_manual.pdf">SiFive E21 Manual</a></li>
</ul>
<p>While doing the porting, we shall compare the above E21 doc with the FE310 doc so that we can identify the differences (e.g. FE310 supports PLIC, E21 doesn't)</p>
<ul>
<li><a href="https://sifive.cdn.prismic.io/sifive/4d063bf8-3ae6-4db6-9843-ee9076ebadf7_fe310-g000.pdf">SiFive FE310 Manual</a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/mynewt-gcc.png" alt="Mynewt's default GCC Compiler is riscv64-unknown-elf-gcc" /></p>
<p><em>Mynewt's default GCC Compiler is <code>riscv64-unknown-elf-gcc</code></em></p>
<h1 id="set-gcc-compiler-for-risc-v" class="section-header"><a href="#set-gcc-compiler-for-risc-v">2 Set GCC Compiler for RISC-V</a></h1>
<p>When building RISC-V Firmware, Mynewt uses the RISC-V GCC Compiler <code>riscv64-unknown-elf-gcc</code> <a href="https://github.com/apache/mynewt-core/blob/master/compiler/riscv64/compiler.yml">(See this)</a></p>
<p>But that's not the same as our compiler from xPack RISC-V GCC: <code>riscv-none-embed-gcc</code></p>
<p><em>(See <a href="https://lupyuen.github.io/articles/debug">&quot;Debug Rust on PineCone BL602 with VSCode and GDB&quot;</a>, Section 1.3, <a href="https://lupyuen.github.io/articles/debug#install-gdb">&quot;Install GDB&quot;</a>)</em></p>
<p>Hence we copy and modify the GCC settings like so: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/tree/main/compiler/riscv-none-embed/compiler.yml"><code>compiler/riscv-none-embed/compiler.yml</code></a></p>
<pre><code class="language-yaml">compiler.path.cc:      &quot;riscv-none-embed-gcc&quot;
compiler.path.as:      &quot;riscv-none-embed-gcc&quot;
compiler.path.archive: &quot;riscv-none-embed-ar&quot;
compiler.path.objdump: &quot;riscv-none-embed-objdump&quot;
compiler.path.objsize: &quot;riscv-none-embed-size&quot;
compiler.path.objcopy: &quot;riscv-none-embed-objcopy&quot;
</code></pre>
<p>Mynewt will now compile our firmware with <code>riscv-none-embed-gcc</code></p>
<h2 id="mynewt-project-and-firmware" class="section-header"><a href="#mynewt-project-and-firmware">2.1 Mynewt Project and Firmware</a></h2>
<p><em>In the screen above, how did we create the Mynewt Project <code>pinecone-rust-mynewt</code> and the Mynewt Firmware <code>pinecone_app</code>?</em></p>
<p>I created <code>pinecone-rust-mynewt</code> and <code>pinecone_app</code> using Mynewt's <code>newt</code> tool.</p>
<p>We'll download them in a while, so you don't need to create them.</p>
<p><em>(FYI: I created <code>pinecone-rust-mynewt</code> and <code>pinecone_app</code> using the steps explained in the sections &quot;Appendix: Install newt&quot; and &quot;Appendix: Create the Mynewt Firmware&quot; below)</em></p>
<p><img src="https://lupyuen.github.io/images/mynewt-mcu.png" alt="Mynewt Microcontroller Definition for BL602" /></p>
<p><em>Mynewt Microcontroller Definition for BL602</em></p>
<h1 id="add-microcontroller-definition" class="section-header"><a href="#add-microcontroller-definition">3 Add Microcontroller Definition</a></h1>
<p>We create a <strong>Microcontroller Definition</strong> to tell Mynewt all about BL602...</p>
<ul>
<li>
<p><strong>BL602 Microcontroller Definition</strong>: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/tree/main/hw/mcu/bl/bl602"><code>hw/mcu/bl/bl602</code></a></p>
</li>
<li>
<p><strong>BL602 Package</strong>: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/hw/mcu/bl/bl602/pkg.yml"><code>pkg.yml</code></a></p>
</li>
<li>
<p><strong>BL602 Configuration</strong>: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/hw/mcu/bl/bl602/syscfg.yml"><code>syscfg.yml</code></a></p>
</li>
</ul>
<p>This contains the code for the <a href="https://github.com/lupyuen/pinecone-rust-mynewt/tree/main/hw/mcu/bl/bl602/src"><strong>Hardware Adaptaion Layer</strong></a> that's specific to BL602 and its built-in Periperal Functions (like Flash Memory, GPIO, I2C, SPI, ...)</p>
<p>The code here was derived from SiFive FE310: <a href="https://github.com/apache/mynewt-core/tree/master/hw/mcu/sifive/fe310"><code>hw/mcu/sifive/fe310</code></a></p>
<h1 id="add-board-support-package" class="section-header"><a href="#add-board-support-package">4 Add Board Support Package</a></h1>
<p>BL602 is present on various boards, PineCone is one of them. The BL602 boards have different features: LEDs, buttons, JTAG debugger, ...</p>
<p>In Mynewt we handle the board differences by creating a <strong>Board Support Package</strong> for PineCone...</p>
<ul>
<li>
<p><strong>PineCone Board Support Package</strong>: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/tree/main/hw/bsp/pinecone"><code>hw/bsp/pinecone</code></a></p>
</li>
<li>
<p><strong>PineCone Definition</strong>: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/hw/bsp/pinecone/bsp.yml"><code>bsp.yml</code></a></p>
</li>
<li>
<p><strong>PineCone Package</strong>: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/hw/bsp/pinecone/pkg.yml"><code>pkg.yml</code></a></p>
</li>
<li>
<p><strong>PineCone Configuration</strong>: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/hw/bsp/pinecone/syscfg.yml"><code>syscfg.yml</code></a></p>
</li>
</ul>
<p>The Board Support Package for PineCone contains code that's specific to PineCone. <a href="https://github.com/lupyuen/pinecone-rust-mynewt/tree/main/hw/bsp/pinecone/src">More details</a></p>
<p>The code here was derived from SiFive HiFive1 Board: <a href="https://github.com/apache/mynewt-core/tree/master/hw/bsp/hifive1"><code>hw/bsp/hifive1</code></a></p>
<h1 id="define-linker-script" class="section-header"><a href="#define-linker-script">5 Define Linker Script</a></h1>
<p>The Linker Script tells GCC Compiler about the Memory Layout for executing our firmware...</p>
<ol>
<li>
<p><strong>Flash Memory Area</strong>: For firmware code and read-only data</p>
</li>
<li>
<p><strong>RAM Memory Area</strong>: For read/write data</p>
</li>
</ol>
<p>Here's our Linker Script for PineCone...</p>
<ul>
<li><strong>PineCone Linker Script</strong>: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/hw/bsp/pinecone/bsp_app.ld"><code>hw/bsp/pinecone/bsp_app.ld</code></a></li>
</ul>
<pre><code class="language-text">MEMORY
{
  /* Use this memory layout when firmware is loaded into cache memory. 
     Based on https://github.com/lupyuen/pinecone-rust/blob/main/memory.x */
  flash (rxai!w) : ORIGIN = 0x22008000, LENGTH = 48K /* Instruction Cache Memory */
  ram   (wxa!ri) : ORIGIN = 0x22014000, LENGTH = 48K /* Data Cache Memory */
}
</code></pre>
<p>Note that we're loading the firmware code and read-only data into BL602's Instruction Cache Memory (similar to RAM), not into Flash Memory. (We'll learn why in a while)</p>
<p>In future when we're ready to load our firmware into Flash Memory, we'll use this memory layout instead...</p>
<pre><code class="language-text">  /* TODO: Use this memory layout when firmware is loaded into Flash Memory 
     Based on Based on https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602/evb/ld/flash_rom.ld */
  flash (rxai!w) : ORIGIN = 0x23000000, LENGTH = 4M   /* Flash Memory */
  ram   (wxa!ri) : ORIGIN = 0x4200c000, LENGTH = 216K /* RAM          */
</code></pre>
<p>(This is commented out in <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/hw/bsp/pinecone/bsp_app.ld"><code>bsp_app.ld</code></a>)</p>
<h2 id="bootloader-image-header" class="section-header"><a href="#bootloader-image-header">5.1 Bootloader Image Header</a></h2>
<p>We're presently not using a Bootloader on PineCone...</p>
<pre><code class="language-text">/* Bootloader not in use. */
_imghdr_size = 0x0;
</code></pre>
<p>In future when we use the Mynewt Bootloader, we need to reserve some space for the Bootloader Image Header, which is located at the start of the firmware code...</p>
<pre><code class="language-text">/* This linker script is used for images and thus contains an image header */
/* TODO: Uncomment the next line when Bootloader is in use */
_imghdr_size = 0x20;
</code></pre>
<h1 id="define-flash-map" class="section-header"><a href="#define-flash-map">6 Define Flash Map</a></h1>
<p>Mynewt's MCUBoot Bootloader will roll back the Active Firmware to the Standby Firmware in case the Active Firmware can't be started.</p>
<p>We define the <strong>Flash Map</strong> to tell Mynewt where in Flash Memory the Bootloader, Active Firmware Image and Standby Firmware Image will be located...</p>
<ul>
<li><strong>PineCone Flash Map</strong>: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/hw/bsp/pinecone/bsp.yml"><code>hw/bsp/pinecone/bsp.yml</code></a></li>
</ul>
<pre><code class="language-yaml"># BL602 Instruction Cache Memory starts at 0x2200 8000, size 48 KB
# Based on https://github.com/lupyuen/pinecone-rust/blob/main/memory.x
bsp.flash_map:
    areas:
        # System areas.
        # (Not Used) Bootloader
        FLASH_AREA_BOOTLOADER:
            device:  0
            offset:  0x22013c00
            size:    1kB    # 0x400
        # Active Firmware Image
        FLASH_AREA_IMAGE_0:
            device:  0 
            offset:  0x22008000
            size:    43kB   # 0xac00
        # (Not Used) Standby Firmware Image, in case Active Firmware can't start
        FLASH_AREA_IMAGE_1:
            device:  0
            offset:  0x22012c00
            size:    1kB    # 0x400
        # (Not used) Scratch Area for swapping Active Firmware and Standby Firmware
        FLASH_AREA_IMAGE_SCRATCH:
            device:  0
            offset:  0x22013000
            size:    1kB    # 0x400
</code></pre>
<p>Remember that we're loading our firmware into Cache Memory (instead of Flash Memory) and we're not using the Bootloader. </p>
<p>That's why we allocate most of the Cache Memory to the Active Firmware Image (located at the start of Cache Memory).</p>
<pre><code class="language-yaml">        # User areas.
        # (Not Used) Reboot Log
        FLASH_AREA_REBOOT_LOG:
            user_id: 0
            device:  0
            offset:  0x22013400
            size:    1kB    # 0x400
        # (Not Used) User File System, like LittleFS
        FLASH_AREA_NFFS:
            user_id: 1
            device:  0
            offset:  0x22013800
            size:    1kB    # 0x400
</code></pre>
<p>Since we have very little Cache Memory, we'll cut down on the Reboot Log and User File Systems.</p>
<h2 id="future-flash-map" class="section-header"><a href="#future-flash-map">6.1 Future Flash Map</a></h2>
<p>The Flash Map looks more meaningful when we're ready to load our firmware into Flash Memory and turn on the Bootloader.</p>
<p>Here is our Flash Map for the future...</p>
<pre><code class="language-yaml"># TODO: Use this memory layout when firmware is loaded into Flash Memory
# BL602 Flash starts at 0x2300 0000, size 4 MB
# Based on https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602/evb/ld/flash_rom.ld
bsp.flash_map:
    areas:
        # System areas.
        # TODO: Bootloader not in use. When used, move Bootloader to 0x2300 0000 and shift the other areas accordingly
        FLASH_AREA_BOOTLOADER:
            device:  0
            offset:  0x2330d000
            size:    32kB      # 0x8000
        # Active Firmware Image
        FLASH_AREA_IMAGE_0:
            device:  0 
            offset:  0x23000000
            size:    1024kB    # 0x100 000
        # Standby Firmware Image, in case Active Firmware can't start
        FLASH_AREA_IMAGE_1:
            device:  0
            offset:  0x23100000
            size:    1024kB    # 0x100 000
        # Scratch Area for swapping Active Firmware and Standby Firmware
        FLASH_AREA_IMAGE_SCRATCH:
            device:  0
            offset:  0x23300000
            size:    4kB       # 0x1000
</code></pre>
<p>(This is commented out in <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/hw/bsp/pinecone/bsp.yml"><code>bsp.yml</code></a>)</p>
<p>In future we'll have a proper Reboot Log and a User File System for saving files and data that will be retained across reboots...</p>
<pre><code class="language-yaml">        # User areas.
        # Reboot Log
        FLASH_AREA_REBOOT_LOG:
            user_id: 0
            device:  0
            offset:  0x23301000
            size:    48kB      #  0xc000
        # User File System, like LittleFS
        FLASH_AREA_NFFS:
            user_id: 1
            device:  0
            offset:  0x23200000
            size:    1024kB    # 0x100 000
</code></pre>
<h1 id="set-firmware-target" class="section-header"><a href="#set-firmware-target">7 Set Firmware Target</a></h1>
<p>We select the Mynewt Firmware to be built by creating a Firmware Target...</p>
<ul>
<li><strong>PineCone Firmware Target</strong>: <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/targets/pinecone_app/target.yml"><code>targets/pinecone_app/target.yml</code></a></li>
</ul>
<pre><code class="language-yaml">target.app: apps/blinky
target.bsp: &quot;hw/bsp/pinecone&quot;
target.build_profile: debug
</code></pre>
<p>Here we specify that our firmware code comes from the <a href="https://github.com/lupyuen/pinecone-rust-mynewt/tree/main/apps/blinky">Blinky Sample App</a>. And our firmware will be compiled for the PineCone BL602 Board.</p>
<p>Also check out the <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/targets/pinecone_app/pkg.yml"><strong>Target Package</strong></a> and the <a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/targets/pinecone_app/syscfg.yml"><strong>Target Configuration</strong></a>.</p>
<h1 id="build-the-firmware" class="section-header"><a href="#build-the-firmware">8 Build the Firmware</a></h1>
<p>TODO</p>
<pre><code class="language-bash">#  Download the source files
git clone --recursive https://github.com/lupyuen/pinecone-rust-mynewt
cd pinecone-rust-mynewt
newt install
#  TODO: Download xpack-riscv-none-embed-gcc here

#  Build the firmware
export PATH=&quot;$PWD/xpack-riscv-none-embed-gcc/bin:$PATH&quot;
newt build pinecone_app
</code></pre>
<h1 id="replace-hal-functions-by-stubs" class="section-header"><a href="#replace-hal-functions-by-stubs">9 Replace HAL Functions by Stubs</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/mynewt-hal.png" alt="Mynewt HAL" /></p>
<h1 id="fill-in-start-code" class="section-header"><a href="#fill-in-start-code">10 Fill in Start Code</a></h1>
<p>TODO</p>
<p>We are using...</p>
<p><a href="https://github.com/lupyuen/pinecone-rust-mynewt/blob/main/hw/mcu/bl/bl602/src/arch/rv32imac/start.s"><code>hw/mcu/bl/bl602/src/arch/rv32imac/start.s</code></a></p>
<p>Based on...</p>
<p><a href="https://github.com/apache/mynewt-core/blob/master/hw/mcu/sifive/fe310/src/arch/rv32imac/start.s"><code>hw/mcu/sifive/fe310/src/arch/rv32imac/start.s</code></a></p>
<p>Though it should look like this...</p>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/blob/master/components/bl602/bl602/evb/src/boot/gcc/start.S"><code>start.S</code></a></p>
<h1 id="decouple-sifive-fe310-from-rv32imac" class="section-header"><a href="#decouple-sifive-fe310-from-rv32imac">11 Decouple SiFive FE310 from RV32IMAC</a></h1>
<p>TODO</p>
<p>Fix dependency of rv32imac on fe310...</p>
<pre><code class="language-text">Error: In file included from repos/apache-mynewt-core/kernel/os/include/os/os_fault.h:24,
                from repos/apache-mynewt-core/libc/baselibc/include/assert.h:24,
                from repos/apache-mynewt-core/hw/hal/src/hal_flash.c:21:
repos/apache-mynewt-core/kernel/os/include/os/arch/rv32imac/os/os_arch.h:24:10: fatal error: mcu/fe310.h: No such file or directory
#include &quot;mcu/fe310.h&quot;
</code></pre>
<p><img src="https://lupyuen.github.io/images/mynewt-fe310.png" alt="SiFive FE310 Reference in RV32IMAC" /></p>
<h1 id="inspect-the-firmware" class="section-header"><a href="#inspect-the-firmware">12 Inspect the Firmware</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/mynewt-disassembly.png" alt="Mynewt Disassembly" /></p>
<pre><code class="language-text">Linking /Users/Luppy/pinecone/pinecone-rust-mynewt/bin/targets/pinecone_app/app/apps/blinky/blinky.elf
Target successfully built: targets/pinecone_app
+ newt size -v pinecone_app
Size of Application Image: app
Mem flash: 0x22008000-0x22014000
Mem ram: 0x22014000-0x22020000
  flash     ram 
      6     525 *fill*
    172       0 @apache-mynewt-core_hw_hal.a
   4494    8213 @apache-mynewt-core_kernel_os.a
     80       0 @apache-mynewt-core_libc_baselibc.a
    702     128 @apache-mynewt-core_sys_flash_map.a
      2       0 @apache-mynewt-core_sys_log_modlog.a
    782      29 @apache-mynewt-core_sys_mfg.a
     30       5 @apache-mynewt-core_sys_sysinit.a
     72       0 @apache-mynewt-core_util_mem.a
     60       8 apps_blinky.a
     44      12 hw_bsp_pinecone.a
    580     228 hw_mcu_bl_bl602.a
     92       0 pinecone_app-sysinit-app.a
    292    1064 libg.a
Loading compiler /Users/Luppy/pinecone/pinecone-rust-mynewt/compiler/riscv-none-embed, buildProfile debug

objsize
   text    data     bss     dec     hex filename
   8488      28    9104   17620    44d4 /Users/Luppy/pinecone/pinecone-rust-mynewt/bin/targets/pinecone_app/app/apps/blinky/blinky.elf
</code></pre>
<p>Mynewt Firmware should look similar to this disassembled Hello World firmware...</p>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/releases/download/v0.0.4/sdk_app_helloworld.S"><code>sdk_app_helloworld.S</code></a></p>
<h1 id="debug-firmware-with-vscode" class="section-header"><a href="#debug-firmware-with-vscode">13 Debug Firmware with VSCode</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/mynewt-debug.png" alt="Mynewt Debugging" /></p>
<h1 id="load-firmware-to-ram-not-flash-memory" class="section-header"><a href="#load-firmware-to-ram-not-flash-memory">14 Load Firmware to RAM, not Flash Memory</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/mynewt-flash.png" alt="Loading Mynewt Firmware to Flash Memory" /></p>
<p><img src="https://lupyuen.github.io/images/mynewt-ram.png" alt="Loading Mynewt Firmware to RAM" /></p>
<h1 id="how-to-test" class="section-header"><a href="#how-to-test">15 How To Test</a></h1>
<p>TODO</p>
<p>Opportunistic porting
Led
Remap
We could test the onboard jumper</p>
<p>Do you have ideas for testing an RTOS on PineCone? Let us know!</p>
<p>Will have Rust</p>
<p>Hope to have NimBLE</p>
<p>WiFi stack
https://github.com/runtimeco/mynewt_arduino_zero/tree/master/apps/winc1500_wifi</p>
<p>https://github.com/runtimeco/mynewt_arduino_zero/tree/master/libs/winc1500</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">16 What's Next</a></h1>
<p>TODO</p>
<p>Failed port to gd32
Now easier to port</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here...</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/mynewt.md"><code>github.com/lupyuen/lupyuen.github.io/src/mynewt.md</code></a></p>
<h1 id="appendix-install-newt" class="section-header"><a href="#appendix-install-newt">17 Appendix: Install newt</a></h1>
<p>TODO</p>
<p>Install the latest version of Go</p>
<pre><code class="language-bash">cd /tmp
export mynewt_version=mynewt_1_8_0_tag
git clone --branch $mynewt_version https://github.com/apache/mynewt-newt/
cd mynewt-newt
./build.sh
sudo mv newt/newt /usr/local/bin
newt version
</code></pre>
<p>Should show...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Apache</span> <span class="ident">Newt</span> <span class="number">1.8</span>.<span class="number">0</span></pre></div>
<h1 id="appendix-create-the-mynewt-firmware" class="section-header"><a href="#appendix-create-the-mynewt-firmware">18 Appendix: Create the Mynewt Firmware</a></h1>
<p>TODO</p>
<p>Install newt</p>
<pre><code class="language-bash">newt new pinecone-rust-mynewt
cd pinecone-rust-mynewt
newt upgrade
newt target create pinecone_app
newt target set pinecone_app app=apps/blinky
# This will be changed to pinecone later
newt target set pinecone_app bsp=@apache-mynewt-core/hw/bsp/hifive1
newt target set pinecone_app build_profile=debug
</code></pre>
<p>https://mynewt.apache.org/latest/tutorials/blinky/blinky_stm32f4disc.html</p>

    
</body>
</html>